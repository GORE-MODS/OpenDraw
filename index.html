<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>OpenDraw - V1.1</title>
  <style>
    body { margin:0; overflow:hidden; background:transparent; }
    canvas { display:block; cursor:crosshair; }
    #toolbar {
      position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.7); color:white;
      padding:10px; border-radius:8px; user-select:none; z-index:999;
    }
    button { margin:4px; padding:6px 10px; }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <div id="toolbar">
    <button onclick="setColor('#ff0000')">Red</button>
    <button onclick="setColor('#0000ff')">Blue</button>
    <button onclick="setColor('#ffffff')">White</button>
    <button onclick="setColor('#00ff00')">Green</button>
    <button onclick="setSize(4)">Thin</button>
    <button onclick="setSize(16)">Thick</button>
    <button onclick="clearCanvas()">Clear</button>
    <button onclick="toggleClickThrough()">Click-Through</button>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let currentColor = '#ff0000';
    let brushSize = 8;
    let history = [];
    let redoStack = [];

    function saveState() {
      history.push(ctx.getImageData(0,0,canvas.width,canvas.height));
      redoStack = [];
      if (history.length > 30) history.shift();
    }

    function resizeCanvas() {
      const temp = document.createElement('canvas');
      temp.width = canvas.width; temp.height = canvas.height;
      temp.getContext('2d').drawImage(canvas,0,0);
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      ctx.drawImage(temp,0,0);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    canvas.addEventListener('mousedown', e => {
      isDrawing = true;
      saveState();
      ctx.beginPath();
      ctx.moveTo(e.clientX, e.clientY);
      ctx.lineTo(e.clientX, e.clientY);
      ctx.strokeStyle = currentColor;
      ctx.lineWidth = brushSize;
      ctx.lineCap = 'round';
      ctx.stroke();
    });

    canvas.addEventListener('mousemove', e => {
      if (!isDrawing) return;
      ctx.lineTo(e.clientX, e.clientY);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.clientX, e.clientY);
    });

    canvas.addEventListener('mouseup', () => { isDrawing = false; ctx.beginPath(); });
    canvas.addEventListener('mouseout', () => { isDrawing = false; ctx.beginPath(); });

    function undo() { if (history.length) { redoStack.push(ctx.getImageData(0,0,canvas.width,canvas.height)); ctx.putImageData(history.pop(),0,0); } }
    function redo() { if (redoStack.length) { history.push(ctx.getImageData(0,0,canvas.width,canvas.height)); ctx.putImageData(redoStack.pop(),0,0); } }

    function setColor(c) { currentColor = c; }
    function setSize(s) { brushSize = s; }
    function clearCanvas() { saveState(); ctx.clearRect(0,0,canvas.width,canvas.height); }
    function toggleClickThrough() {
      ipcRenderer.send('set-clickthrough', true);
      setTimeout(() => ipcRenderer.send('set-clickthrough', false), 80);
    }

    ipcRenderer.on('clear-canvas', clearCanvas);
    ipcRenderer.on('set-color', (_,c) => setColor(c));
    ipcRenderer.on('set-size', (_,s) => setSize(s));
    ipcRenderer.on('toggle-clickthrough', toggleClickThrough);
    ipcRenderer.on('undo', undo);
    ipcRenderer.on('redo', redo);
  </script>
</body>
</html>